<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="assets/logo-background.png">
    <title>Retriever - E2E Observability Platform</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Apply theme immediately to prevent flash of unstyled content
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>
    <!-- Navigation Bar -->
    <header>
        <nav>
            <a href="index.html">
                <img src="assets/logo-background.png" alt="Retriever Logo">
                Retriever
            </a>
            <div class="nav-right">
                <a href="#case-study">Case Study</a>
                <a href="team.html">Our Team</a>
                <button class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
                    <svg class="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <a href="https://github.com/TeamRetriever/retriever" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                    </svg>
                </a>
            </div>
        </nav>
    </header>

    <!-- Landing Page Content -->
    <main>
        <section class="logo-links-container">
            <!-- Logo Section -->
            <div class="logo-section">
                <img src="assets/logo-background.png" alt="Retriever Logo + Description">
            </div>
            <!-- Links Section -->
            <div class="links-section">
                <a href="#case-study">Read the Case Study</a>
                <a href="get-started.html">Get Started</a>
            </div>
        </section>

        <!-- Case Study Content -->
        <section id="case-study" class="case-study-content">
            <!-- Table of Contents Sidebar -->
            <aside class="toc-sidebar">
                <nav class="toc-nav">
                    <ul class="toc-list">
                        <li><a href="#what-is-retriever">What is Retriever?</a></li>
                        <li><a href="#modern-observability">Modern Observability</a></li>
                        <li><a href="#existing-solutions">Existing Observability Solutions</a></li>
                        <li><a href="#retriever-solution">Retriever's Solution</a></li>
                        <li><a href="#walkthrough">Walkthrough</a></li>
                        <li><a href="#design-decisions">Important Design Decisions</a></li>
                        <li><a href="#architecture">Architecture</a></li>
                        <li><a href="#future-development">Future Development</a></li>
                        <li><a href="#team">Our Team</a></li>
                    </ul>
                </nav>
            </aside>
            <div class="case-study-container">
                <h1 id="what-is-retriever">1. What is Retriever?</h1>
                <p>Retriever is an open-source, self-hosted observability service that puts valuable telemetry data in the hands of small teams. If you're running your application in AWS, Retriever can be ready to collect and display data in a few minutes. AI agents can use the Retriever MCP server to query and analyze data, so that you can diagnose and solve problems without having to alt-tab out of your IDE.</p>

                <div class="diagram-image-container-large">
                    <img src="assets/diagrams/retriever-high-level.png" alt="Retriever High Level Architecture">
                </div>

                <h2 id="modern-observability">2. Modern Observability</h2>
                
                <h3 id="what-is-observability">2.1 What is Observability?</h3>
                <p>Observability, at its heart, is about the ability to understand the state of your application, now and in the past. With observability, an engineering team can, for example, see how that spike in site traffic is pushing the p95 response time from 200ms to 1.5 seconds. An observable application is one that lets us see that, say, memory usage on a particular service is steadily climbing toward its limit.</p>
                <p>Observability is critical when, inevitably, something goes sideways in production and all heads turn toward the engineering team until the problem is identified and fixed.</p>
                <p>Traditionally, teams relied on logging application output to the console to understand what was happening. The problem with unstructured logs is that there is no direct link between a log and its corresponding request, or to a specific, say, spike in 500 errors. Modern observability addresses this with multiple signals: metrics to spot anomalies, traces to follow requests across services, and logs to capture the details. Together, this telemetry data turns "something is broken" into "this specific database query in the purchase order service is timing out."</p>

                <h3 id="observability-applied">2.2 Observability Applied</h3>
                <p>The first step in building an observable system is instrumentation, where developers write code within their application to send telemetry data to a central location. Once the application is instrumented, it sends its telemetry to a collector, an application designed to format and filter telemetry. The industry standard is OpenTelemetry, which defines both instrumentation SDKs and a protocol (OTLP) for transmitting telemetry.</p>
                
                <div class="diagram-image-container">
                    <img src="assets/diagrams/app-generating-telemetry.png" alt="App Generating Telemetry">
                </div>
                
                <p>Once we're collecting data, we need a place to store it. Telemetry data has specialized storage requirements: new data is written to the database frequently and continuously, old data never needs to be updated, and very large volumes of data can accumulate over time. Specialized databases are needed to meet these requirements; we discuss some of the options for trace storage in section 5.2.</p>
                
                <p>Now that all that telemetry is stored for querying when something goes awry, we need a way to visualize the telemetry--turning it from large JSON blobs into something that's easy to visually parse--so that we can easily use the telemetry to trace the issue to its source.</p>
                
                <p>In practice, this workflow typically starts with an alert: for instance, a Slack message triggered when a service's error rate spikes. The alert directs engineers to a visualizer where they can dig into the telemetry. That way, engineers can focus on their current sprint, and only need to divert their attention to their observability tools when a problem arises.</p>

                <h3 id="why-trace-first">2.3 Why Trace-First Telemetry?</h3>
                <p>Metrics and logs each play an important role in telemetry. Metrics are excellent for aggregating data points, like CPU utilization, over time, which helps engineers identify anomalies in the production environment. But a metric tells you that something is wrong, not where; when an error rate spikes, without other context, metrics generally can't pinpoint the culprit service. Meanwhile, logs usefully capture detailed, human-readable information about individual events. That said, correlating individual logs to reconstruct a single request's path can be a tedious task even in a monolithic architecture.</p>
                
                <p>Given the complexity of modern applications, traces emerged to address the observability challenges introduced by distributed systems; they stitch together all the sub-requests associated with a single incoming request so that developers can understand every step in the lifecycle of a request as it hops from service to service. A single trace is made of multiple spans, with the first span representing the root span and underlying spans representing a process that occurs during the parent request. Traces capture the complete journey of a request as it flows through multiple services, and therefore allow for powerful root cause analysis across a distributed system.</p>
                
                <p>Traces enable root cause analysis, but finding the relevant trace among thousands still requires manual investigation. This is where AI agents can help—if they can access the trace data.</p>

                <h3 id="agentic-ai-observability">2.4 Agentic AI in Observability</h3>
                
                <p>A modern approach to observability integrates AI agents. Utilizing AI to debug in production previously required iterations of combing through recent telemetry data and reasoning about which data was important context, then copy/pasting it into a chat with the agent, followed by iterations of narrowing or widening the context to eventually figure out the root cause. Finally, the bug fix is written and the solution pushed to prod.</p>
                
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/debugging-without-mcp.png" alt="Debugging without MCP">
                </div>
                
                <p>Ideally, teams want to give the agent the ability to query trace data directly, so that it can perform root cause analysis side-by-side with the developer. This functionality was previously unlocked by writing a custom integration for an LLM client to query the trace store. The tradeoff to writing a custom integration is that if a team switches models (say, from Anthropic to Open AI) or clients (Cursor to Claude Code), a new integration would be needed--new authentication handling, new API wrappers, new response parsing--which could lead to endless cycles of integration writing and maintaining.</p>
                
                <p>The Model Context Protocol (MCP), has become widely adopted in 2025, largely because it cures the headaches around integrating each client individually. MCP is a standardized, model-agnostic protocol to enable new functionality in AI clients: an MCP server exposes callable functions (tools), the host (e.g., Cursor) can invoke those tools, and the LLM receives the results. For observability specifically, this means an MCP server can expose tools to Cursor that enable it to query the trace data store or recent metrics. From there, it can iterate on its own to perform root cause analysis.</p>
                
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/debugging-with-mcp.png" alt="Debugging with MCP">
                </div>
                
                <p>It's worth noting one challenge for AI in observability applications: telemetry is generally verbose, by design, to give a large amount of context to human engineers who are making sense of the system. This verbosity presents a challenge for MCP-based debugging tools: telemetry data has been known to 'blow up the context window' when debugging with an agent. We describe a few approaches to addressing this challenge in section 6.7.</p>

                <h2 id="existing-solutions">3. Existing Observability Solutions</h2>

                <h3 id="commercial-saas">3.1 Commercial SaaS Platforms</h3>
                <p>Platforms like Datadog and Honeycomb allow teams to abstract away the complexity of observability. The user takes responsibility for instrumenting their app, and the platform handles everything else. These enterprise solutions generally offer (or are developing) MCP integration for AI-assisted debugging.</p>
                <p>These services are feature-rich and easy to use, but they aren't cheap. Users might be surprised to find their observability bill eating up a significant chunk of their budget. Costs can also explode unpredictably based on innocuous-looking instrumentation choices, like sending high-cardinality metric data.</p>
                <p>Even if Datadog were free, it might not be every team's first choice. Users cede ownership of their telemetry data to the platform provider. They may have little or no control over how much of their data the provider retains, or for how long, and choosing to change providers generally means leaving behind historical data.</p>

                <h3 id="self-hosted">3.2 Self-Hosted Open-Source Tools</h3>
                <p>If you don't want to buy your observability, you can always build it. There are many open-source solutions out there, from full-featured suites like the Grafana stack to cutting-edge high-performance tools like Quickwit.</p>
                <p>These don't cost money, but they can cost significant engineer time. Setting up and maintaining observability services gets complicated quickly; a full-fledged observability stack is its own microservice architecture, with all the needs that implies. Adding an MCP only increases the burden: some open source options have them, but some details, like authentication, are left to the user to figure out. Time spent building your observability stack is time that could be spent building valuable product features.</p>

                <h2 id="retriever-solution">4. Retriever's Solution</h2>
                
                <h3 id="what-retriever-offers">4.1 What Retriever Offers</h3>
                <p>Running the Retriever command-line tool will spin up a complete observability platform in AWS, ready to accept, store, and display telemetry data.</p>
                <p>Retriever is focused on trace data and does not accept traditional logs or metrics. Instead, users can instrument their application to emit log data in the form of span events embedded within traces. Retriever also derives metrics, such as error rates, from the trace data it receives. Users can configure alerts based on these metrics to be sent to a Slack channel, email address, or wherever is most convenient.</p>
                <p>Users can query, filter, and search their trace data in a web dashboard. Their AI agents can do the same via the Retriever MCP server. A simple configuration in Cursor to connect the MCP, a prompt like "Cursor, are there any errors in our recent telemetry?" and it has tools to read recent trace data to pinpoint problems and suggest fixes.</p>

                <h3 id="intended-user">4.2 The Intended User</h3>
                <p>We built Retriever for small teams running their applications in AWS. Retriever is for teams that want:</p>
                <ul>
                    <li>to pay only the AWS costs associated with Retriever's infrastructure</li>
                    <li>to keep their telemetry data in-house, confined to their AWS VPC</li>
                    <li>to spend their engineering time on other valuable goals</li>
                    <li>to leverage agentic AI in their debugging workflow</li>
                </ul>
                <p>Retriever is not a good fit for:</p>
                <ul>
                    <li>large organizations that can afford an SaaS provider and want the powerful features these providers offer</li>
                    <li>teams that have already built their own observability services</li>
                    <li>teams running their applications in other cloud providers, or outside the cloud entirely</li>
                </ul>

                <h3 id="comparing-retriever">4.3 Comparing Retriever with Other Solutions</h3>
                <div class="diagram-image-container-large">
                    <img src="assets/diagrams/retriever-vs-others.png" alt="Retriever vs Other Solutions Comparison">
                </div>

                <h2 id="walkthrough">5. Walkthrough</h2>
                <p class="diagram-placeholder">(suggested by Ian to give a quick visual snapshot of Retriever so readers have context for the rest of the writeup. An example walkthrough section is here: https://kubrick-ai.com/case-study/walkthrough/)</p>

                <h2 id="design-decisions">6. Important Design Decisions / Tradeoffs</h2>
                
                <h3 id="scoping-signals">6.1 Scoping Our Signals</h3>
                <p>While the observability field recognizes three primary types of telemetry signals (as a recap - logs, metrics, and traces), it's not a given that a solution should support all three. Each signal must be ingested, stored, and queried in a different way, typically by different services; signals must also be correlated so that users can know, for instance, what logs belong to what traces. The question for us, then, was whether focusing on one or two signals could offer our users a more streamlined experience without sacrificing functionality.</p>
                <p>As we researched open-source observability tools, we found ways to work with traces without sacrificing the descriptive power of logs or the high-level digestibility of metrics. By focusing solely on trace data, we were able to simplify our architecture, reduce infrastructure costs, and offer the user a more streamlined experience.</p>

                <h3 id="choosing-backend">6.2 Choosing A Backend</h3>
                <p>While it's certainly possible to build a trace backend from scratch, that wasn't the focus of Retriever. We wanted to take one of the many high-quality open-source options and package it with simple automated deployment and MCP functionality. After discarding some clearly unsuitable options like the ELK stack and GreptimeDB, we were left with two candidates: Grafana and Jaeger.</p>
                
                <h4>Grafana</h4>
                <p>The Grafana stack is an ecosystem of services that handle different telemetry signals, with Grafana itself as the visualization service that pulls all of the telemetry data together. Trace storage is handled with the Tempo service.</p>
                <p>Tempo uses AWS S3 to store trace data cheaply. The Grafana dashboard is a very flexible visualization tool. Using Grafana would also allow us to expand Retriever to handle the other telemetry signals in the future.</p>
                <p>However, there was a red flag: trace querying. Originally, it wasn't possible to query traces at all in Tempo; you had to find a trace id in a metric or log, then look up that id in Tempo. Tempo has recently added TraceQL for true trace querying, but this is a young feature that is still being updated, and not yet a good foundation for a dedicated trace observability service like Retriever.</p>
                
                <h4>Jaeger</h4>
                <p>Jaeger is an open-source solution purpose-built for trace data. It's mature and widely adopted, but not out of date - in fact, Jaeger v2 was released in late 2024.</p>
                <p>The Jaeger dashboard isn't as open-ended as other options like Grafana; you're limited to a few standardized views of your data. However, this isn't necessarily a bad thing. As we test-drove backends, the Jaeger UI stood out as easy and pleasant to use, while still allowing for flexible querying.</p>
                <p>As a battle-tested solution with a shared focus on trace data, Jaeger stood out as a natural fit for Retriever.</p>
                
                <div class="diagram-image-container-large">
                    <img src="assets/diagrams/jaeger-vs-others.png" alt="Jaeger vs Other Platforms Comparison">
                </div>

                <h3 id="choosing-datastore">6.3 Choosing a Data Store</h3>
                <p>Having settled on Jaeger as our query and UI solution, it was time to choose a storage solution. Jaeger supports several integrations, but many of these were clearly the wrong fit. For instance, Apache Cassandra is a distributed database with incredible scalability, but our target user doesn't operate at a scale that generates the massive volumes of data Cassandra is suited for; a simpler database architecture is better. Clickhouse is an extremely performant column-oriented database, but there isn't yet an official Jaeger integration, and we didn't want to rely on the experimental integration.</p>
                <p>Another interesting option was Quickwit, a search engine that's optimized to store data in object storage (like AWS S3) with a high compression rate, and query massive volumes of that data quickly. While not officially integrated with Jaeger, we had the option to use a non-Jaeger telemetry collector (most likely the OpenTelemetry Collector) to gather telemetry data, then use the Jaeger query and UI services to pull data from Quickwit.</p>
                <p>However, like a sports car, Quickwit must be tuned carefully to perform at its best. This means setting up your data indexing during Quickwit setup. Without knowing the exact shape of our end user's telemetry data, it wasn't clear what indexes would deliver the best performance. Quickwit is also still in early development (not yet at 1.0.0 at time of writing), meaning we would need to keep up with breaking changes as we built Retriever.</p>
                <p>That left us with Elasticsearch and OpenSearch. Elasticsearch is a document database with powerful text search capabilities. It's not as performant as a columnar database like Clickhouse for certain tasks, but at our target user's scale, the difference isn't significant. Like Jaeger, Elasticsearch is a mature solution used throughout the industry.</p>
                <p>In the last few years, Elasticsearch switched from open-source to a more ambiguous dual license, and then switched back. This made us hesitant to adopt Elasticsearch, and led us to the open-source fork OpenSearch. We missed Elasticsearch's excellent documentation, but not much else - OpenSearch behaves very similarly and performs comparably. We discuss OpenSearch in more detail here.</p>

                <h3 id="jaeger-architecture">6.4 All-In-One vs Separate Jaeger Architecture</h3>
                <p>Jaeger can be configured to run in an "all-in-one" configuration, where a single Jaeger service handles collecting and querying data, or it can be configured as a separate "collector" service and "query/UI" service. While we prioritized simplicity throughout Retriever's design, we still felt that separating the two services was worth it. Collector traffic will be much higher than query traffic, so the collector should be able to scale out independently as needed. Separating the services also gave us more insight into the behavior of each service in isolation as we built our infrastructure; users maintaining their Retriever services will inherit this ease of monitoring and troubleshooting.</p>

                <h3 id="deploying-retriever">6.5 Deploying Retriever</h3>
                <p>From the beginning, we planned for Retriever to be a service users would self-host in AWS. Our first big infrastructure decision was: where in AWS? Retriever could deploy in its own VPC, separate from the VPC the user's application was running in. The user would send their telemetry data to some public endpoint provided by Retriever.</p>
                <p>There was a lot to like about this strategy. It compartmentalized Retriever from the user's other AWS services. It didn't require that the user have any particular infrastructure set up already. In fact, it didn't require that the user run their application in AWS at all - the application could run anywhere, in a cloud or on-premises, and still use Retriever.</p>
                <p>The downside was security. Since telemetry data was traveling over the public internet, it needed to be encrypted and connections needed to be authenticated. The OpenTelemetry standard mandates MTLS (Mutual Transport Layer Security) for this, which the user would need to configure for their own application. Security also adds compute time to every request; since telemetry collection involves a continuous stream of requests, this adds up.</p>
                <p>To avoid these problems, we decided to deploy Retriever such that the Jaeger collector ran in the same private subnet as the user's telemetry-emitting service. Here, the telemetry data never leaves the subnet, meaning we don't need to worry about a secure connection. Users need to provide the VPC and subnets, but they don't have to worry about configuring MTLS.</p>
                
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/one-vpc.png" alt="Retriever in User's VPC">
                </div>
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/two-vpcs.png" alt="Retriever in Separate VPCs">
                </div>

                <h3 id="orchestrating-containers">6.6 Orchestrating Containers</h3>
                <p>AWS offers a suite of options for deploying containerized services. We quickly ruled out EKS (Elastic Kubernetes Service). Kubernetes is a useful and powerful way of orchestrating containers in production, but it's overbuilt for Retriever's needs. Retriever only involves a handful of containers, none of which we expect to scale dramatically. Kubernetes' features come at the cost of high operational complexity that, in the long run, our users would be responsible for handling.</p>
                <p>ECS (Elastic Container Service) is much simpler to set up and maintain, while still offering the features necessary for a production application. We considered deploying ECS services over a cluster of EC2 (Elastic Cloud Compute) instances, which would let us constrain user costs to the cost of the provisioned instances. However, this comes with its own maintenance burden for the user; for instance, the user would have to manually install security updates on their instances over time.</p>
                <p>In line with Retriever's focus on user convenience, we opted to use AWS's serverless container offering, Fargate, instead. We expect Fargate to be slightly more expensive, but it makes Retriever much more of a "set and forget" service, with minimal maintenance needs.</p>

                <h3 id="mcp-implementation">6.7 MCP Implementation</h3>
                <p>Overall, what did we have to problem solve here</p>
                <ul>
                    <li>Why a few powerful tools + intended workflow for agents</li>
                    <li>Time hallucination, use of `lookback` for the agent, but translation to start_time and end_time via the server</li>
                    <li>Selective context extraction</li>
                    <li>Building the request to Jaeger/Prometheus (can be brief, specify the timeframe</li>
                    <li>Server-side filtering for successful (not supported by the backend)</li>
                    <li>Data transformation</li>
                    <li>Reducing verbose OTLP structure to just the relevant ids, tags, and status codes</li>
                </ul>
                
                <p>We knew that we wanted to provide an MCP that allowed for Cursor to seamlessly and securely integrate into the typical debugging workflow. One initial decision we faced was determining which of two Jaeger Query APIs to integrate: the leaner v1, which returns trace data that is 4x smaller, or the better-documented v3, which returns larger, data-rich traces.</p>
                <p>The v3 API requires time fields</p>
                
                <p>The Retriever MCP went through various iterations with its tools. At first, get_traces was two separate tools: get_traces and get_errors. get_service_health was intended to be one of two tools focused on the health of a service, with the second being a compare_services tool to be able to compare two different periods of time and the service's state. After reflection, we determined that each pair could be merged together for a more fully fleshed out and effective tooling. Ultimately, it seemed better for a user to have to do fewer tool calls and be able to form the shape of the call to more accurately reflect their inquiries.</p>
                <p>It became quickly apparent that Data Distillation would be a major component of the MCP server to account for. When working with traces as a structure across large services, these objects that are returned can become immensely large in size. Early in the tool development stage, get_traces had no distillation, and even one single trace would go over the limit for an MCP host like Cursor. The distillation method that the Retriever MCP incorporates was able to shrink the size of the object upwards of 90-95%. All while preserving critical attributes necessary for appropriate responses.</p>
                <p>This distillation was accomplished by utilizing the structure of the Jaeger v3 api. The documentation for this api shows the structure of trace data, and this allowed for business logic to iterate through nested objects to relevant data for particular attributes. For example with a single trace if we wanted to grab the span events from it you would iterate through the top level resourceSpans then iterate through scopeSpans, then you can access spans. For a particular span you can then access events. All relevant properties are accessed in the same way. Each individual property is small in isolation and because of this exponential decrease in volume of data being returned, trace data is allowed to be queried and used for troubleshooting purposes without any issues related to speed or effectiveness.</p>
                
                <p>An additional decision that was made pertained to handling the calculation logic of date and time-related data. Both the Jaeger and Prometheus APIs required specific time formatting, and therefore, the option was available to leave calculating that time to be more human-readable to the LLM. For a myriad of factors, LLMs tend to struggle with time (8). And through testing, this also reared its head, often hallucinating improper times and dates. Therefore, business logic was added in for the MCP to handle this logic so LLM models would not have to process it.</p>

                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/before-data-distillation.png" alt="Before Data Distillation">
                </div>
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/after-data-distillation.png" alt="After Data Distillation">
                </div>

                <h2 id="architecture">7. Architecture</h2>
                <div class="diagram-image-container-medium image-modal-trigger">
                    <img src="assets/diagrams/retriever-architecture.png" alt="Retriever Architecture Diagram" class="modal-image">
                </div>
                <p>When a user runs the setup process in the CLI, Retriever uses Terraform to provision its infrastructure and start running its services:</p>

                <h3 id="jaeger-collector">7.1 Jaeger Collector</h3>
                <p>The Jaeger Collector is the endpoint for the user's trace data. As spans arrive, the Collector derives aggregated spanmetrics that record request counts, error rates, and request durations (RED metrics). Rather than sending each span directly to OpenSearch, the Collector sends data in periodic batches to reduce network traffic. The spanmetrics are exposed on a port to be scraped by Prometheus.</p>
                
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/collector-processor-exporter.png" alt="Collector, Processor, and Exporter">
                </div>

                <h3 id="opensearch">7.2 OpenSearch</h3>
                <p>OpenSearch stores trace data, writing new data in bulk as it receives each batch from the Collector. Each span is stored as its own document.</p>
                <p>When it's time to query this data, OpenSearch uses inverted indices(9) to quickly find the desired traces and spans. Indices are partitioned by day; because traces are naturally grouped by time and queries typically focus on recent data, this partitioning strategy doesn't slow down querying.</p>
                
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/forward-index.png" alt="Forward Index Diagram">
                </div>
                <p style="max-width: 75%; margin: 12px auto 24px; font-style: italic; color: var(--text-secondary); text-align: left;">Forward Indexing Allows for Fast, Cheap Data Ingestion and Storage</p>
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/inverted-index.png" alt="Inverted Index Diagram">
                </div>
                <p style="max-width: 75%; margin: 12px auto 24px; font-style: italic; color: var(--text-secondary); text-align: left;">Inverted Indexing Allows for More Queryable Telemetry</p>

                <h3 id="prometheus">7.3 Prometheus and AlertManager</h3>
                <p>Prometheus stores metric data, scraping spanmetrics from the Jaeger Collector at short intervals, and takes responsibility for alerting. In Retriever, Prometheus is configured to fire alerts based on general heuristics, such as a service that returns an error more than 5% of the time. These alerts are sent to AlertManager, which in turn delivers them to a user-specified endpoint.</p>
                <p>Because spanmetrics are RED metrics derived from span data, they resemble SLOs (service-level objectives) more than traditional metrics like CPU usage. Spanmetric-based alerts reflect problems in the consumer experience of your application.</p>

                <h3 id="jaeger-query">7.4 Jaeger Query and UI</h3>
                <p>Jaeger Query acts as a bridge between the trace storage and anything that needs the trace data; it provides a RESTful API for the UI and MCP.</p>
                
                <div class="diagram-image-container-medium">
                    <img src="assets/diagrams/jaeger-query.png" alt="Jaeger Query Architecture">
                </div>
                
                <p>The Jaeger UI runs as part of the query service. Users can access the dashboard over the public internet via a load balancer. From there, they can search and filter to find the data they want, examine individual traces and spans in detail, and view spanmetrics pulled from Prometheus.</p>
                
                <div class="diagram-image-container-large">
                    <img src="assets/diagrams/visualizer-jaeger.png" alt="Jaeger UI Trace Waterfall">
                </div>

                <h3 id="mcp-server-arch">7.5 MCP Server</h3>
                <p>The Retriever MCP server is a TypeScript application using Express and the Model Context Protocol SDK. Because the MCP is designed to run in the cloud, it communicates over StreamableHTTP, the standard protocol for remote client/MCP communication. Clients connect to the MCP through the same load balancer that directs users to the Jaeger UI, with a POST request to the path /mcp.</p>
                <p>Once a connection is established, clients can use the server's primary tools: list_services, get_traces, and get_service_health. When a client invokes a tool, the MCP server makes requests to Jaeger Query and Prometheus for trace and metric data, respectively. It then processes this data for compactness and LLM- or human-readability, and sends its result to the client.</p>

                <h3 id="securing-retriever">7.6 Securing Retriever</h3>
                <p>…</p>

                <h2 id="future-development">8. Future Development</h2>
                
                <h3 id="enhancing-mcp">8.1 Enhancing The MCP Server</h3>
                <p>The current setup for the Retriever MCP is tool-focused. And while it still provides impressive results, there is still ample room for the other primitives to be added in. Resources and Prompts will provide even more effective responses. Furthermore, JSON is the structure of the data that the MCP is being fed. It is effective, but TOON (Token-Oriented Object Notation) has become well known for efficient token usage for LLMS during the development of Retriever. It has been shown to increase token efficiency by upwards of 60% and even on the low end, it is safely 25% more effective. (9) Therefore, becoming more comfortable with TOON and including it in the MCP in the near future is a priority.</p>

                <h2 id="team">Our Team</h2>
                <div class="team-grid">
                    <div class="team-member">
                        <img src="assets/Benji.jpeg" alt="Benjamin Walker">
                        <p class="team-name">Benjamin Walker</p>
                        <p class="team-role">Software Engineer</p>
                        <p class="team-location">Chicago, IL</p>
                        <div class="team-social">
                            <a href="mailto:benjamin.q.walker@gmail.com" aria-label="Email Benjamin Walker">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </a>
                            <a href="https://github.com/bwalkerq" target="_blank" rel="noopener noreferrer" aria-label="GitHub Benjamin Walker">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                                </svg>
                            </a>
                            <a href="https://www.linkedin.com/in/benjamin-walker-899a5b162/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Benjamin Walker">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                    <div class="team-member">
                        <img src="assets/Philip.jpeg" alt="Philip Knapp">
                        <p class="team-name">Philip Knapp</p>
                        <p class="team-role">Software Engineer</p>
                        <p class="team-location">Chicago, IL</p>
                        <div class="team-social">
                            <a href="mailto:philipsknapp@gmail.com" aria-label="Email Philip Knapp">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </a>
                            <a href="https://github.com/philipsknapp" target="_blank" rel="noopener noreferrer" aria-label="GitHub Philip Knapp">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                                </svg>
                            </a>
                            <a href="https://www.linkedin.com/in/philip-knapp-48660b7b/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Philip Knapp">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                    <div class="team-member">
                        <img src="assets/Zane.jpeg" alt="Zane Lee">
                        <p class="team-name">Zane Lee</p>
                        <p class="team-role">Software Engineer</p>
                        <p class="team-location">Charleston, SC</p>
                        <div class="team-social">
                            <a href="mailto:kcstills17@gmail.com" aria-label="Email Zane Lee">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </a>
                            <a href="https://github.com/Kcstills17" target="_blank" rel="noopener noreferrer" aria-label="GitHub Zane Lee">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                                </svg>
                            </a>
                            <a href="https://www.linkedin.com/in/zane-lee-14496a297/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Zane Lee">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                    <div class="team-member">
                        <img src="assets/Ryan.jpeg" alt="Ryan Foley">
                        <p class="team-name">Ryan Foley</p>
                        <p class="team-role">Software Engineer</p>
                        <p class="team-location">Hartford, CT</p>
                        <div class="team-social">
                            <a href="mailto:ryan.a.foley@icloud.com" aria-label="Email Ryan Foley">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                    <polyline points="22,6 12,13 2,6"/>
                                </svg>
                            </a>
                            <a href="https://github.com/ryandoesdata" target="_blank" rel="noopener noreferrer" aria-label="GitHub Ryan Foley">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                                </svg>
                            </a>
                            <a href="https://www.linkedin.com/in/ryandoesdata/" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn Ryan Foley">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script>
        // Handle active section highlighting in TOC with scroll-based visibility
        const tocLinks = document.querySelectorAll('.toc-list a');
        const sections = document.querySelectorAll('.case-study-container h1, .case-study-container h2');
        const caseStudyContent = document.querySelector('.case-study-content');
        const tocSidebar = document.querySelector('.toc-sidebar');
        const logoLinksContainer = document.querySelector('.logo-links-container');
        
        // Make TOC links jump instantly instead of smooth scrolling
        tocLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const targetId = href.substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        // Temporarily disable smooth scrolling
                        document.documentElement.style.scrollBehavior = 'auto';
                        const targetRect = targetElement.getBoundingClientRect();
                        const targetPosition = targetRect.top + window.scrollY - 80; // Account for fixed header
                        window.scrollTo(0, targetPosition);
                        // Re-enable smooth scrolling after a brief delay
                        setTimeout(() => {
                            document.documentElement.style.scrollBehavior = '';
                        }, 0);
                    }
                }
            });
        });
        
        // Threshold for showing TOC (when user scrolls past the hero section)
        const TOC_SHOW_THRESHOLD = 300;

        function updateTOCVisibility() {
            if (!tocSidebar || !logoLinksContainer) return;

            const scrollPosition = window.scrollY;
            const heroBottom = logoLinksContainer.offsetTop + logoLinksContainer.offsetHeight;
            
            // Find the "Future Development" section - hide TOC when we reach it
            const futurePlansSection = document.getElementById('future-development');
            let shouldShow = false;
            
            if (futurePlansSection) {
                // Get absolute position relative to document
                const futurePlansRect = futurePlansSection.getBoundingClientRect();
                const futurePlansTop = scrollPosition + futurePlansRect.top;
                // Hide TOC when we reach the Future Development section
                shouldShow = scrollPosition > heroBottom - TOC_SHOW_THRESHOLD && 
                            scrollPosition < futurePlansTop;
            } else {
                // Fallback if section not found
                shouldShow = scrollPosition > heroBottom - TOC_SHOW_THRESHOLD;
            }

            if (shouldShow) {
                tocSidebar.classList.add('visible');
            } else {
                tocSidebar.classList.remove('visible');
            }
        }

        function updateActiveSection() {
            if (!caseStudyContent) return;
            
            let current = '';
            let currentSection = null;
            let currentSectionTop = 0;
            let currentSectionBottom = 0;
            const scrollPosition = window.scrollY;
            const contentTop = caseStudyContent.offsetTop;
            const viewportHeight = window.innerHeight;

            // Find the current section and calculate its boundaries (only h1 and h2)
            sections.forEach((section, index) => {
                const sectionTop = contentTop + section.offsetTop;
                const nextSection = sections[index + 1];
                const sectionBottom = nextSection 
                    ? contentTop + nextSection.offsetTop 
                    : contentTop + caseStudyContent.offsetHeight;
                
                if (scrollPosition + 200 >= sectionTop && scrollPosition < sectionBottom) {
                    current = section.getAttribute('id');
                    currentSection = section;
                    currentSectionTop = sectionTop;
                    currentSectionBottom = sectionBottom;
                }
            });

            // Update TOC links and calculate progress
            tocLinks.forEach(link => {
                link.classList.remove('active', 'progress');
                const href = link.getAttribute('href');
                
                if (href && href === '#' + current && currentSection) {
                    link.classList.add('active');
                    
                    // Calculate scroll progress within the current section
                    const sectionHeight = currentSectionBottom - currentSectionTop;
                    const scrollProgress = Math.max(0, Math.min(1, 
                        (scrollPosition + viewportHeight / 2 - currentSectionTop) / sectionHeight
                    ));
                    
                    // Apply progress to the active link
                    link.style.setProperty('--progress', scrollProgress);
                    link.classList.add('progress');
                    
                    // Scroll TOC to show active link
                    if (tocSidebar && tocSidebar.classList.contains('visible')) {
                        const linkTop = link.offsetTop;
                        const linkHeight = link.offsetHeight;
                        const sidebarHeight = tocSidebar.offsetHeight;
                        const scrollTop = tocSidebar.scrollTop;
                        
                        if (linkTop < scrollTop) {
                            tocSidebar.scrollTo({ top: linkTop - 20, behavior: 'smooth' });
                        } else if (linkTop + linkHeight > scrollTop + sidebarHeight) {
                            tocSidebar.scrollTo({ top: linkTop - sidebarHeight + linkHeight + 20, behavior: 'smooth' });
                        }
                    }
                }
            });
        }

        // Combined scroll handler
        function handleScroll() {
            updateTOCVisibility();
            updateActiveSection();
        }

        window.addEventListener('scroll', handleScroll);
        updateTOCVisibility(); // Initial call
        updateActiveSection(); // Initial call

        // Dark Mode Toggle
        (function() {
            const themeToggle = document.querySelector('.theme-toggle');
            const html = document.documentElement;
            
            // Get saved theme or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', savedTheme);
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        })();

        // Image Modal Functionality
        (function() {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-overlay"></div>
                <div class="image-modal-content">
                    <button class="image-modal-close" aria-label="Close modal">&times;</button>
                    <img src="" alt="" class="image-modal-img">
                </div>
            `;
            document.body.appendChild(modal);

            const modalImg = modal.querySelector('.image-modal-img');
            const overlay = modal.querySelector('.image-modal-overlay');
            const closeBtn = modal.querySelector('.image-modal-close');

            function openModal(imgSrc, imgAlt) {
                modalImg.src = imgSrc;
                modalImg.alt = imgAlt;
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Make all images in diagram containers clickable
            const diagramContainers = document.querySelectorAll('.diagram-image-container, .diagram-image-container-medium, .diagram-image-container-large, .image-modal-trigger');
            diagramContainers.forEach(container => {
                const img = container.querySelector('img');
                if (img) {
                    container.style.cursor = 'pointer';
                    container.addEventListener('click', () => {
                        openModal(img.src, img.alt);
                    });
                }
            });

            overlay.addEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closeModal();
                }
            });
        })();
    </script>
</body>
</html>
